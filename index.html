<script src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js'></script>
<style>
    .row {
        display: flex;
        justify-content: space-between;
    }
    .col {
        width: 32%;
    }
    #content-container {
        border: 1px solid black;
        width: 90%;
        align-content: center;
    }
    .pagination-control {
        display: inline;
    }
    .pagination-btn {
        padding: 0px 5px;
    }
</style>
<body>
    <form>
        <label for="search">Search</label>
        <input id="searchTerm" name="searchTerm" type="text">
        <button id="search">Search</button>
    </form>
    <div id="output-container">
        <div id="content-container"></div>
        <div id="pagination-control"></div>
    </div>
</body>

<script>
    var file = 'http://localhost:3013/file/caplist_feb_2020.csv';
    var RESULTS_PER_PAGE = 25;
    var numPages = 1;
    var searchResults = [];

    (function() {
        var searchButton = document.getElementById('search');
        searchButton.onclick = queryCSV;
        
    })();
        
    var OMISSIONS = ['CorpName'];  
    
    function addPaginationButton(pageNumber, container) {
        var pageButton = document.createElement('button');
        pageButton.className += ' pagination-btn';
        pageButton.id += (' pagination-' + pageNumber);
        pageButton.appendChild(document.createTextNode(pageNumber));
        // Add event listener to button
        pageButton.addEventListener('click', function(event) {
            // Clear data container
            var dataContainer = document.getElementById('content-container');
            while (dataContainer.firstChild) {
                console.log(dataContainer.firstChild, 'Being removed ^');
                dataContainer.removeChild(dataContainer.lastChild);
            }
            var data = [];
            for (var j = pageNumber + RESULTS_PER_PAGE; j < RESULTS_PER_PAGE * pageNumber; j++) {
                data.push(searchResults[j]);
            }
            displayData(data);
        });
        container.appendChild(pageButton);
    }

    function displayData(data) {
        var container = document.getElementById('content-container');
        for (var i = 0; i < data.length; i++) {
            var row = document.createElement('div');
            row.className += ' row';
            for (key in data[i]) {
                if (data[i].hasOwnProperty(key) && OMISSIONS.indexOf(key) == -1) {
                    var column = document.createElement('div');
                    column.className += (' col ' + i);
                    var attributeText = data[i][key];
                    var columnText = document.createElement('p');
                    columnText.appendChild(document.createTextNode(attributeText));
                    column.appendChild(columnText);
                    row.appendChild(column);
                }
            }
            var column = document.createElement('div');
            column.className += (' col ' + i + ' add-button');
            var addButton = document.createElement('button');
            addButton.appendChild(document.createTextNode('Add To Quote List'));
            column.appendChild(addButton);
            row.appendChild(column);
            container.appendChild(row);
        }
        if (numPages > 1) {
            var paginationControl = document.getElementById('pagination-control');
            if (numPages > 2) {
                for (var i = 1; i <= 3; i++) {
                    addPaginationButton(i, paginationControl);
                }
                if (numPages > 3) {
                    paginationControl.appendChild(document.createTextNode('...'));
                    addPaginationButton(numPages, paginationControl);
                }
            } else {
                for (var i = 1; i <= numPages; i++) {
                    addPaginationButton(i, paginationControl);
                }
            }
        }
    }
    
    function queryCSV(event) {
        event.preventDefault();

        
        // Loop through children and delete them
        
        var searchTerm = document.getElementById('searchTerm').value;
        console.log(searchTerm);
        
        Papa.parse(file, {
            download: true,
            header: true,
            step: function (data) {
                var record = data.data;

                // search for term in PN
                for (var key in record) {
                    if (record.hasOwnProperty(key)) {
                        var attribute = record[key];
                    
                        if (attribute.length > 0 && typeof(attribute) == "string" &&
                        attribute.toLowerCase().indexOf(searchTerm.toLowerCase()) != -1) {
                            // Bingo, we got a match
                            console.log(record);
                            searchResults.push(record);
                            break;
                        }
                    }
                }
                
            },
            complete: function (data) {
                console.log(searchResults);
                // Get only the first RESULTS_PER_PAGE amount of results to display
                var pageResults = [];
                numPages = Math.ceil(searchResults.length/RESULTS_PER_PAGE);
                for (var i = 0; i < RESULTS_PER_PAGE; i++) {
                    pageResults.push(searchResults[i]);
                }
                displayData(pageResults);
            }
        });
    }

</script>